<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fingerprint Attendance (Local Demo)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px 0; padding: 10px; }
    select, input { padding: 8px; width: 250px; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>
<body>

<h2>Fingerprint Attendance System (No Backend)</h2>

<h3>Register Employee</h3>
<input id="regName" placeholder="Employee name" />
<br />
<button onclick="registerEmployee()">Register (Fingerprint)</button>

<h3>Clock In / Out</h3>
<select id="loginSelect"></select>
<br />
<button onclick="loginEmployee()">Clock In / Out (Fingerprint)</button>

<h3>Stored Employees (LocalStorage)</h3>
<pre id="output"></pre>

<script>
/* ------------------ Utilities ------------------ */

function bufferToBase64(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)));
}

function base64ToBuffer(base64) {
  return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
}

function loadEmployees() {
  return JSON.parse(localStorage.getItem("employees") || "{}");
}

function saveEmployees(data) {
  localStorage.setItem("employees", JSON.stringify(data));
  refreshUI();
}

function refreshUI() {
  const employees = loadEmployees();
  const select = document.getElementById("loginSelect");
  select.innerHTML = "";

  Object.keys(employees).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });

  document.getElementById("output").textContent =
    JSON.stringify(employees, null, 2);
}

/* ------------------ Registration ------------------ */

async function registerEmployee() {
  const name = document.getElementById("regName").value.trim();
  if (!name) {
    alert("Enter employee name");
    return;
  }

  const employees = loadEmployees();
  if (employees[name]) {
    alert("Employee already registered");
    return;
  }

  const challenge = crypto.getRandomValues(new Uint8Array(32));

  const credential = await navigator.credentials.create({
    publicKey: {
      challenge,
      rp: { name: "Attendance Demo" },
      user: {
        id: crypto.getRandomValues(new Uint8Array(16)),
        name,
        displayName: name
      },
      pubKeyCredParams: [{ type: "public-key", alg: -7 }],
      authenticatorSelection: {
        userVerification: "required"
      },
      timeout: 60000
    }
  });

  const publicKey = credential.response.getPublicKey();
  const credentialId = credential.rawId;

  employees[name] = {
    credentialId: bufferToBase64(credentialId),
    publicKey: bufferToBase64(publicKey),
    registeredAt: new Date().toISOString()
  };

  saveEmployees(employees);
  alert(name + " registered successfully");
}

/* ------------------ Login ------------------ */

async function loginEmployee() {
  const name = document.getElementById("loginSelect").value;
  if (!name) {
    alert("Select employee");
    return;
  }

  const employees = loadEmployees();
  const emp = employees[name];

  const challenge = crypto.getRandomValues(new Uint8Array(32));

  try {
    const assertion = await navigator.credentials.get({
      publicKey: {
        challenge,
        allowCredentials: [{
          type: "public-key",
          id: base64ToBuffer(emp.credentialId)
        }],
        userVerification: "required",
        timeout: 60000
      }
    });

    alert(name + " clocked in/out successfully ✅");

  } catch (err) {
    alert("Authentication failed ❌");
  }
}

/* ------------------ Init ------------------ */
refreshUI();
</script>

</body>
</html>
